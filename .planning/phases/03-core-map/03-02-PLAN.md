---
phase: 03-core-map
plan: "02"
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - frontend/src/bee-map.ts
  - frontend/src/bee-sidebar.ts
autonomous: true
requirements:
  - MAP-02

must_haves:
  truths:
    - "Clicking a cluster opens the sidebar showing a list of samples grouped by (date + collector + fieldNumber)"
    - "Each sample entry shows date, collector, and fieldNumber as a header with species names listed below"
    - "Multiple samples within a click are ordered most-recent-first"
    - "Clicking elsewhere on the map (no feature at pixel) dismisses specimen details and returns to summary statistics"
    - "The sidebar default state shows summary statistics: total specimens, species/genus/family counts, and year range"
    - "A close/back control inside the panel also returns to summary statistics"
    - "Desktop: sidebar is a fixed 25rem right panel with left border"
    - "Mobile (max-aspect-ratio: 1): map at 50svh, sidebar fills remaining space below"
  artifacts:
    - path: "frontend/src/bee-sidebar.ts"
      provides: "bee-sidebar LitElement with summary and specimen-detail views"
      exports: ["BeeSidebar"]
      contains: "customElement('bee-sidebar')"
    - path: "frontend/src/bee-map.ts"
      provides: "singleclick handler + selectedSamples state + bee-sidebar in template"
      contains: "selectedSamples"
  key_links:
    - from: "frontend/src/bee-map.ts"
      to: "frontend/src/bee-sidebar.ts"
      via: "bee-sidebar element in render() template with .samples and .summary bindings"
      pattern: "bee-sidebar"
    - from: "frontend/src/bee-map.ts"
      to: "ol/layer/Vector.getFeatures"
      via: "singleclick event handler using specimenLayer.getFeatures(event.pixel)"
      pattern: "getFeatures"
    - from: "frontend/src/bee-map.ts"
      to: "frontend/src/bee-sidebar.ts"
      via: "@close event handler sets selectedSamples = null"
      pattern: "@close"
---

<objective>
Add click-to-detail sidebar: clicking a cluster or individual point opens a sidebar showing sample details; clicking elsewhere returns to summary statistics.

Purpose: MAP-02 — collectors must be able to click any point or cluster and see who collected what species on what date.
Output: New bee-sidebar.ts component; updated bee-map.ts with click handler, sidebar layout, and reactive state.
</objective>

<execution_context>
@/Users/rainhead/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rainhead/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-map/03-CONTEXT.md
@.planning/phases/03-core-map/03-RESEARCH.md
@.planning/phases/03-core-map/03-01-SUMMARY.md
@frontend/src/bee-map.ts
@frontend/src/parquet.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bee-sidebar LitElement</name>
  <files>frontend/src/bee-sidebar.ts</files>
  <action>
Create a new file `frontend/src/bee-sidebar.ts` with a `bee-sidebar` LitElement. This component receives data via properties and renders either a summary stats view or a specimen detail view.

**Interfaces (define at top of file):**
```typescript
export interface Sample {
  year: number;
  month: number;
  recordedBy: string;
  fieldNumber: string;
  species: string[];
}

export interface DataSummary {
  totalSpecimens: number;
  speciesCount: number;
  genusCount: number;
  familyCount: number;
  earliestYear: number;
  latestYear: number;
}
```

**Component structure:**
```typescript
import { css, html, LitElement } from 'lit';
import { customElement, property } from 'lit/decorators.js';

@customElement('bee-sidebar')
export class BeeSidebar extends LitElement {
  @property({ attribute: false })
  samples: Sample[] | null = null;

  @property({ attribute: false })
  summary: DataSummary | null = null;

  // ...
}
```

**Render logic:**
- If `this.samples !== null`, render the specimen detail view.
- Otherwise, render the summary statistics view.

**Summary statistics view** (default, nothing selected):
```html
<div class="panel-content">
  <h2>Washington Bee Atlas</h2>
  <dl>
    <dt>Specimens</dt><dd>${summary.totalSpecimens.toLocaleString()}</dd>
    <dt>Species</dt><dd>${summary.speciesCount}</dd>
    <dt>Genera</dt><dd>${summary.genusCount}</dd>
    <dt>Families</dt><dd>${summary.familyCount}</dd>
    <dt>Years</dt><dd>${summary.earliestYear}–${summary.latestYear}</dd>
  </dl>
  <p class="hint">Click a specimen point or cluster to see sample details.</p>
</div>
```
Show a loading state if `summary` is null (data still loading).

**Specimen detail view** (samples selected):
- A "Back" button at top that dispatches `new CustomEvent('close', { bubbles: true, composed: true })` on click.
- A list of sample entries. Each entry is a `<section>` or `<article>` with a header showing: formatted date (e.g., "June 2023"), collector name, fieldNumber — and below the header, an unordered list of species names.
- Format month as the full month name. Use `new Intl.DateTimeFormat('en-US', { month: 'long' }).format(new Date(sample.year, sample.month - 1))` for month formatting.
- Samples are already sorted most-recent-first by the time they arrive (bee-map.ts will sort before passing).

**Styles** (use `static styles = css\`...\``):
- `:host { display: flex; flex-direction: column; overflow-y: auto; font-family: system-ui, sans-serif; }`
- `.panel-content { padding: 1rem; }`
- `.back-btn { margin: 0.75rem; padding: 0.4rem 0.75rem; cursor: pointer; border: 1px solid #ccc; background: transparent; border-radius: 4px; font-size: 0.9rem; }`
- `.sample { padding: 0.75rem 1rem; border-bottom: 1px solid #eee; }`
- `.sample-header { font-weight: 600; margin-bottom: 0.25rem; font-size: 0.9rem; }`
- `.sample-meta { font-size: 0.8rem; color: #666; margin-bottom: 0.5rem; }`
- `.species-list { margin: 0; padding-left: 1.25rem; font-size: 0.85rem; font-style: italic; }`
- `dt { font-weight: 600; font-size: 0.85rem; } dd { margin: 0 0 0.5rem 0; font-size: 1rem; }`
- `.hint { color: #888; font-size: 0.85rem; font-style: italic; }`

The panel must be structured to accommodate filter and search controls above the specimen list in Phase 4 — do not hard-code specimen-only layout at the root level. The `<div class="panel-content">` wrapper pattern gives Phase 4 room to insert controls above it.
  </action>
  <verify>
TypeScript compiles without errors: `cd /Users/rainhead/dev/beeatlas/frontend && npx tsc --noEmit`
  </verify>
  <done>bee-sidebar.ts exists; exports BeeSidebar, Sample, DataSummary; @customElement('bee-sidebar') decorator present; renders summary view when samples=null and specimen detail view when samples is set; close button dispatches 'close' CustomEvent; TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Wire click handler, summary computation, sidebar layout in bee-map.ts</name>
  <files>frontend/src/bee-map.ts</files>
  <action>
Update `bee-map.ts` to add: reactive state properties, singleclick handler, summary stats computation, sidebar element in template, and layout adjustments. This task builds on the cluster source wired in plan 01.

**1. Add imports:**
```typescript
import { state } from 'lit/decorators.js';
import './bee-sidebar.ts';
import type { Sample, DataSummary } from './bee-sidebar.ts';
import Feature from 'ol/Feature.js';
```

**2. Add reactive state to BeeMap class:**
```typescript
@state()
private selectedSamples: Sample[] | null = null;

@state()
private summary: DataSummary | null = null;
```

**3. Add buildSamples helper** (static method or module-level function):
```typescript
function buildSamples(features: Feature[]): Sample[] {
  const map = new Map<string, Sample>();
  for (const f of features) {
    const key = `${f.get('year')}-${f.get('month')}-${f.get('recordedBy')}-${f.get('fieldNumber')}`;
    if (!map.has(key)) {
      map.set(key, {
        year: f.get('year') as number,
        month: f.get('month') as number,
        recordedBy: f.get('recordedBy') as string,
        fieldNumber: f.get('fieldNumber') as string,
        species: [],
      });
    }
    map.get(key)!.species.push(f.get('scientificName') as string);
  }
  return [...map.values()].sort((a, b) => b.year - a.year || b.month - a.month);
}
```

**4. Add computeSummary helper** (module-level function):
```typescript
function computeSummary(features: Feature[]): DataSummary {
  const species = new Set<string>();
  const genera = new Set<string>();
  const families = new Set<string>();
  let min = Infinity, max = -Infinity;
  for (const f of features) {
    const s = f.get('scientificName') as string;
    const g = f.get('genus') as string;
    const fam = f.get('family') as string;
    if (s) species.add(s);
    if (g) genera.add(g);
    if (fam) families.add(fam);
    const y = f.get('year') as number;
    if (y < min) min = y;
    if (y > max) max = y;
  }
  return {
    totalSpecimens: features.length,
    speciesCount: species.size,
    genusCount: genera.size,
    familyCount: families.size,
    earliestYear: min === Infinity ? 0 : min,
    latestYear: max === -Infinity ? 0 : max,
  };
}
```

**5. In firstUpdated()**, after the map is created:

a) Listen for source load to compute summary. The specimenSource (from plan 01, a VectorSource wrapped by Cluster) fires `'change'` when loaded. Listen on `specimenSource` (not clusterSource) so you get actual features:
```typescript
specimenSource.once('change', () => {
  const features = specimenSource.getFeatures();
  if (features.length > 0) {
    this.summary = computeSummary(features);
  }
});
```

b) Register the singleclick handler. Access `speicmenLayer` (the VectorLayer from plan 01 — note the existing typo in the variable name, preserve it):
```typescript
this.map!.on('singleclick', async (event) => {
  const hits = await speicmenLayer.getFeatures(event.pixel);
  if (!hits.length) {
    this.selectedSamples = null;
    return;
  }
  const inner: Feature[] = (hits[0].get('features') as Feature[]) ?? [hits[0] as unknown as Feature];
  this.selectedSamples = buildSamples(inner);
});
```

**6. Update render()** to include bee-sidebar and update styles:

In the returned html template, add `<bee-sidebar>` alongside `<div id="map">`:
```typescript
return html`
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.8.0/ol.css" type="text/css" />
  <div id="map"></div>
  <bee-sidebar
    .samples=${this.selectedSamples}
    .summary=${this.summary}
    @close=${() => { this.selectedSamples = null; }}
  ></bee-sidebar>
`;
```

**7. Update static styles** — expand the existing css`` block to add sidebar layout (preserving existing :host and #map rules, adding sidebar rules):

Add to the existing `static styles = css\`...\`` block:
```css
bee-sidebar {
  width: 25rem;
  border-left: 1px solid #cccccc;
  overflow-y: auto;
}
@media (max-aspect-ratio: 1) {
  :host {
    flex-direction: column;
  }
  #map {
    height: 50svh;
    flex-grow: 0;
    flex-shrink: 0;
  }
  bee-sidebar {
    width: 100%;
    border-left: none;
    border-top: 1px solid #cccccc;
    flex-grow: 1;
  }
}
```

The existing `:host { display: flex; flex-direction: row; flex-grow: 1; overflow: auto; }` and `#map { flex-grow: 1 }` rules are correct — keep them; the media query overrides apply on top.

**Key pitfalls to avoid (from RESEARCH.md):**
- Do NOT access data via `hits[0].get('year')` — cluster features don't have those props. Always unwrap via `.get('features')`.
- Do NOT use `click` event — use `singleclick` (250ms debounced OL event).
- Do NOT put two singleclick handlers (one for open, one for dismiss) — single handler branches on `hits.length`.
- Do NOT put `<bee-sidebar>` outside the shadow DOM render output — it must be inside `render()`.
  </action>
  <verify>
TypeScript compiles without errors: `cd /Users/rainhead/dev/beeatlas/frontend && npx tsc --noEmit`

Then visual test: `npm run dev`
1. Map loads — sidebar shows "Washington Bee Atlas" with loading state then populated stats
2. Click a cluster — sidebar switches to specimen detail list with samples
3. Click empty map area — sidebar returns to summary stats
4. Click "Back" button — sidebar returns to summary stats
5. Resize browser to portrait — map takes top half, sidebar fills bottom
  </verify>
  <done>bee-map.ts has @state() selectedSamples and summary properties; singleclick handler reads cluster inner features; summary computed on source load; bee-sidebar rendered in template with .samples/.summary props and @close handler; sidebar layout rules added to static styles; TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `cd /Users/rainhead/dev/beeatlas/frontend && npx tsc --noEmit` — zero errors
2. `npm run build` completes without errors
3. Full interactive test via `npm run dev`:
   - Summary stats populate after data loads
   - Clicking a cluster shows sample list (date / collector / fieldNumber header + species list)
   - Clicking empty map returns to summary
   - Back button returns to summary
   - Portrait viewport: map top, sidebar bottom
</verification>

<success_criteria>
- MAP-02: Clicking any point or cluster shows sample details (verified interactively)
- Sidebar default state shows summary statistics (total specimens, species/genus/family counts, year range)
- Dismiss works via both map click (no feature) and Back button
- 25rem fixed right panel on desktop; below-map panel on portrait
- Panel structure is extensible for Phase 4 filter controls
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-map/03-02-SUMMARY.md` capturing:
- Files modified and key changes made
- How specimenSource.once('change') fires (confirm it triggers before or after features are available)
- Any issues with the singleclick handler or Feature type casting
- TypeScript compile status
- Visual test results
</output>
