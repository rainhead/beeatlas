---
phase: 02-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/package.json
  - infra/tsconfig.json
  - infra/cdk.json
  - infra/bin/infra.ts
  - infra/lib/beeatlas-stack.ts
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02

must_haves:
  truths:
    - "Running `npm run cdk synth` inside `infra/` produces a CloudFormation template without errors"
    - "The synthesized template contains an S3 bucket with BlockPublicAccess.BLOCK_ALL and no websiteIndexDocument"
    - "The synthesized template contains a CloudFront distribution using OAC (not OAI) with defaultRootObject index.html"
    - "The synthesized template contains a GitHub OIDC provider for token.actions.githubusercontent.com"
    - "The synthesized template contains an IAM role with trust condition scoped to repo:rainhead/beeatlas:*"
    - "The template has CfnOutputs for BucketName, DistributionId, DistributionDomain, and DeployerRoleArn"
  artifacts:
    - path: "infra/lib/beeatlas-stack.ts"
      provides: "Full CDK stack: S3 bucket, CloudFront distribution with OAC, OIDC provider, deployer role, CfnOutputs"
      contains: "S3BucketOrigin.withOriginAccessControl"
    - path: "infra/bin/infra.ts"
      provides: "CDK App entry point"
      contains: "new BeeAtlasStack"
    - path: "infra/cdk.json"
      provides: "CDK CLI configuration"
      contains: "npx ts-node bin/infra.ts"
    - path: "infra/package.json"
      provides: "CDK dependencies"
      contains: "aws-cdk-lib"
  key_links:
    - from: "infra/bin/infra.ts"
      to: "infra/lib/beeatlas-stack.ts"
      via: "import { BeeAtlasStack }"
      pattern: "BeeAtlasStack"
    - from: "infra/lib/beeatlas-stack.ts"
      to: "aws-cdk-lib/aws-cloudfront-origins"
      via: "S3BucketOrigin.withOriginAccessControl(siteBucket)"
      pattern: "withOriginAccessControl"
    - from: "deployerRole"
      to: "siteBucket"
      via: "siteBucket.grantReadWrite(deployerRole)"
      pattern: "grantReadWrite"
---

<objective>
Scaffold the CDK TypeScript project in `infra/` and implement the full BeeAtlasStack: S3 bucket with private access, CloudFront distribution using Origin Access Control (OAC), GitHub OIDC provider, and a deployer IAM role scoped to the `rainhead/beeatlas` repository.

Purpose: Defines the AWS infrastructure as code so it can be deployed repeatably without stored credentials. This is the foundation for keyless CI/CD in Plan 02.
Output: A synthesizable CDK project that produces a CloudFormation template defining the full static-site hosting stack with OIDC authentication.
</objective>

<execution_context>
@/Users/rainhead/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rainhead/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-infrastructure/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold CDK TypeScript project in infra/</name>
  <files>
    infra/package.json
    infra/tsconfig.json
    infra/cdk.json
    infra/bin/infra.ts
  </files>
  <action>
Create the `infra/` directory structure manually (do NOT run `cdk init` — it would overwrite files and require interactive input).

**infra/package.json** — install these exact packages:
```json
{
  "name": "beeatlas-infra",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "cdk": "cdk",
    "build": "tsc",
    "watch": "tsc -w",
    "synth": "cdk synth",
    "deploy": "cdk deploy"
  },
  "dependencies": {
    "aws-cdk-lib": "^2.238.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  },
  "devDependencies": {
    "aws-cdk": "^2.1106.1",
    "typescript": "~5.7.0",
    "ts-node": "^10.9.2",
    "@types/node": "^22.0.0"
  }
}
```

**infra/tsconfig.json** — standard CDK TypeScript config:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["es2020"],
    "declaration": true,
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "noImplicitThis": true,
    "alwaysStrict": true,
    "outDir": "./dist",
    "rootDir": ".",
    "experimentalDecorators": true
  },
  "exclude": ["node_modules", "dist"]
}
```

**infra/cdk.json** — CDK CLI configuration:
```json
{
  "app": "npx ts-node bin/infra.ts",
  "watch": {
    "include": ["**"],
    "exclude": ["README.md", "cdk*.json", "**/*.d.ts", "**/*.js", "tsconfig.json", "node_modules"]
  },
  "context": {
    "@aws-cdk/aws-apigateway:usagePlanKeyOrderInsensitiveId": true,
    "@aws-cdk/core:stackRelativeExports": true,
    "@aws-cdk/aws-s3:serverAccessLogsUseBucketPolicy": true
  }
}
```

**infra/bin/infra.ts** — CDK App entry point:
```typescript
#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { BeeAtlasStack } from '../lib/beeatlas-stack';

const app = new cdk.App();
new BeeAtlasStack(app, 'BeeAtlasStack', {
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: process.env.CDK_DEFAULT_REGION ?? 'us-east-1',
  },
});
```

Then run `npm install` inside `infra/` to install dependencies:
```bash
cd /path/to/repo/infra && npm install
```
  </action>
  <verify>
Run from inside `infra/`:
```bash
npm ls aws-cdk-lib 2>/dev/null | head -5
npx ts-node --version
```
Both should succeed without errors. `node_modules/aws-cdk-lib` must exist.
  </verify>
  <done>
`infra/package.json`, `infra/tsconfig.json`, `infra/cdk.json`, and `infra/bin/infra.ts` all exist. `npm install` completed with no errors. `npx ts-node --version` prints a version string.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement BeeAtlasStack with S3, CloudFront OAC, OIDC provider, and deployer role</name>
  <files>
    infra/lib/beeatlas-stack.ts
  </files>
  <action>
Create `infra/lib/beeatlas-stack.ts` with the complete stack. Use the exact patterns from research — no deviations.

**Critical constraints:**
- Use `S3BucketOrigin.withOriginAccessControl(siteBucket)` — NOT the deprecated `S3Origin` (OAI)
- Do NOT set `websiteIndexDocument` on the S3 bucket — use `defaultRootObject: 'index.html'` on the Distribution instead
- OIDC provider: no `thumbprints` array needed (AWS added GitHub to root CAs in late 2024)
- OIDC sub claim: use `StringLike` with `repo:rainhead/beeatlas:*` (scoped to repo, any branch/tag)
- Deployer role: grant `sts:AssumeRole` on `arn:aws:iam::${this.account}:role/cdk-*` plus direct S3 + CloudFront permissions
- OIDC provider already exists fallback: document with a code comment that if `cdk deploy` fails with "Provider already exists", replace `new iam.OpenIdConnectProvider(...)` with `iam.OpenIdConnectProvider.fromOpenIdConnectProviderArn(this, 'GH', 'arn:aws:iam::ACCOUNT:oidc-provider/token.actions.githubusercontent.com')`

```typescript
import * as cdk from 'aws-cdk-lib';
import * as s3 from 'aws-cdk-lib/aws-s3';
import * as cloudfront from 'aws-cdk-lib/aws-cloudfront';
import * as origins from 'aws-cdk-lib/aws-cloudfront-origins';
import * as iam from 'aws-cdk-lib/aws-iam';
import { Construct } from 'constructs';

export class BeeAtlasStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // ── S3 Bucket (private — no website hosting mode) ─────────────────────
    const siteBucket = new s3.Bucket(this, 'SiteBucket', {
      blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
      removalPolicy: cdk.RemovalPolicy.DESTROY,
      autoDeleteObjects: true,  // safe: bucket and distribution are in the same stack
    });

    // ── CloudFront Distribution with OAC ──────────────────────────────────
    // Use S3BucketOrigin.withOriginAccessControl() (stable since CDK v2.156.0).
    // Do NOT use deprecated S3Origin (OAI). Do NOT set websiteIndexDocument on bucket.
    const distribution = new cloudfront.Distribution(this, 'SiteDistribution', {
      defaultBehavior: {
        origin: origins.S3BucketOrigin.withOriginAccessControl(siteBucket),
        viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
        cachePolicy: cloudfront.CachePolicy.CACHING_OPTIMIZED,
      },
      defaultRootObject: 'index.html',
    });

    // ── GitHub OIDC Provider ───────────────────────────────────────────────
    // One per AWS account per URL. No thumbprints needed as of late 2024.
    // If cdk deploy fails with "Provider already exists", replace this block with:
    //   const githubProvider = iam.OpenIdConnectProvider.fromOpenIdConnectProviderArn(
    //     this, 'GitHubOidcProvider',
    //     `arn:aws:iam::${this.account}:oidc-provider/token.actions.githubusercontent.com`
    //   );
    const githubProvider = new iam.OpenIdConnectProvider(this, 'GitHubOidcProvider', {
      url: 'https://token.actions.githubusercontent.com',
      clientIds: ['sts.amazonaws.com'],
    });

    // ── Deployer Role ──────────────────────────────────────────────────────
    // Scoped to rainhead/beeatlas repo (any branch/tag/environment).
    // StringLike allows wildcards; StringEquals is exact match for audience.
    const deployerRole = new iam.Role(this, 'GitHubDeployerRole', {
      roleName: 'beeatlas-github-deployer',
      assumedBy: new iam.WebIdentityPrincipal(
        githubProvider.openIdConnectProviderArn,
        {
          StringLike: {
            'token.actions.githubusercontent.com:sub': 'repo:rainhead/beeatlas:*',
          },
          StringEquals: {
            'token.actions.githubusercontent.com:aud': 'sts.amazonaws.com',
          },
        },
      ),
      maxSessionDuration: cdk.Duration.hours(1),
    });

    // Allow deployer to assume CDK bootstrap roles (needed for cdk deploy from CI)
    deployerRole.addToPolicy(new iam.PolicyStatement({
      effect: iam.Effect.ALLOW,
      actions: ['sts:AssumeRole'],
      resources: [`arn:aws:iam::${this.account}:role/cdk-*`],
    }));

    // Grant direct S3 read/write (workflow syncs frontend/dist/ directly)
    siteBucket.grantReadWrite(deployerRole);

    // Grant CloudFront invalidation (workflow runs create-invalidation after S3 sync)
    deployerRole.addToPolicy(new iam.PolicyStatement({
      effect: iam.Effect.ALLOW,
      actions: ['cloudfront:CreateInvalidation'],
      resources: [
        `arn:aws:cloudfront::${this.account}:distribution/${distribution.distributionId}`,
      ],
    }));

    // ── Outputs (consumed as GitHub Actions secrets) ──────────────────────
    new cdk.CfnOutput(this, 'BucketName', {
      value: siteBucket.bucketName,
      description: 'S3 bucket name → GitHub secret S3_BUCKET_NAME',
    });
    new cdk.CfnOutput(this, 'DistributionId', {
      value: distribution.distributionId,
      description: 'CloudFront distribution ID → GitHub secret CF_DISTRIBUTION_ID',
    });
    new cdk.CfnOutput(this, 'DistributionDomain', {
      value: distribution.distributionDomainName,
      description: 'CloudFront domain for verifying the live site',
    });
    new cdk.CfnOutput(this, 'DeployerRoleArn', {
      value: deployerRole.roleArn,
      description: 'OIDC deployer role ARN → GitHub secret AWS_DEPLOYER_ROLE_ARN',
    });
  }
}
```

After writing the file, verify it type-checks cleanly:
```bash
cd /path/to/repo/infra && npx tsc --noEmit
```
  </action>
  <verify>
From inside `infra/`:
```bash
npx tsc --noEmit
```
Must exit 0 with no TypeScript errors.

Then synthesize:
```bash
npx cdk synth 2>&1 | head -50
```
Must produce CloudFormation JSON/YAML output starting with `Resources:` (or print the stack template). Any error here means the code or CDK setup has a problem.

Also confirm key patterns exist in the file:
```bash
grep -c "withOriginAccessControl\|GitHubOidcProvider\|WebIdentityPrincipal\|DeployerRoleArn" infra/lib/beeatlas-stack.ts
```
Should print 4.
  </verify>
  <done>
`infra/lib/beeatlas-stack.ts` exists. `npx tsc --noEmit` exits 0. `npx cdk synth` produces a CloudFormation template containing the S3 bucket, CloudFront distribution, OIDC provider, deployer role, and all four CfnOutputs. TypeScript compilation is clean.
  </done>
</task>

</tasks>

<verification>
From inside `infra/`:
1. `npx tsc --noEmit` exits 0 — TypeScript compiles cleanly
2. `npx cdk synth` exits 0 — CloudFormation template is valid and printed
3. Template contains `AWS::S3::Bucket`, `AWS::CloudFront::Distribution`, `AWS::IAM::OIDCProvider`, `AWS::IAM::Role`
4. Template contains Outputs: `BucketName`, `DistributionId`, `DistributionDomain`, `DeployerRoleArn`
5. No `S3Origin` (deprecated OAI) appears — only `S3BucketOrigin`
6. Bucket has no `WebsiteConfiguration` property (that would enable website hosting mode)
</verification>

<success_criteria>
- `infra/` directory exists with all five files: `package.json`, `tsconfig.json`, `cdk.json`, `bin/infra.ts`, `lib/beeatlas-stack.ts`
- `npm install` completed, `node_modules/` populated
- `npx tsc --noEmit` exits 0 (no type errors)
- `npx cdk synth` exits 0 and produces a valid CloudFormation template
- Template includes S3 bucket (BLOCK_ALL public access, no website mode), CloudFront distribution (OAC, defaultRootObject=index.html), GitHub OIDC provider, deployer role scoped to `repo:rainhead/beeatlas:*`, and four CfnOutputs
- INFRA-01 satisfied: S3 + CloudFront with `S3BucketOrigin.withOriginAccessControl()`
- INFRA-02 satisfied: OIDC IAM role scoped to `repo:rainhead/beeatlas`, no stored credentials
</success_criteria>

<output>
After completion, create `.planning/phases/02-infrastructure/02-01-SUMMARY.md`
</output>
