---
phase: 02-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - .github/workflows/deploy.yml
autonomous: false
requirements:
  - INFRA-03

must_haves:
  truths:
    - "Pushing any branch to GitHub triggers the `build` job and the frontend compiles successfully"
    - "Pushing to `main` additionally triggers the `deploy` job which assumes the OIDC role without stored credentials"
    - "After a push to `main`, `frontend/dist/` contents are synced to S3 and a CloudFront wildcard invalidation runs"
    - "The CloudFront URL serves the current version of the frontend immediately after deploy"
    - "The workflow file contains no `aws-access-key-id` or `aws-secret-access-key` values"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "Two-job CI/CD workflow: build (all pushes) + deploy (main only, OIDC)"
      contains: "role-to-assume"
  key_links:
    - from: ".github/workflows/deploy.yml deploy job"
      to: "AWS IAM OIDC provider"
      via: "aws-actions/configure-aws-credentials@v4 with role-to-assume"
      pattern: "role-to-assume.*AWS_DEPLOYER_ROLE_ARN"
    - from: ".github/workflows/deploy.yml deploy job"
      to: "S3 bucket"
      via: "aws s3 sync frontend/dist/ s3://${{ secrets.S3_BUCKET_NAME }}"
      pattern: "s3 sync.*S3_BUCKET_NAME"
    - from: ".github/workflows/deploy.yml deploy job"
      to: "CloudFront distribution"
      via: "aws cloudfront create-invalidation"
      pattern: "create-invalidation.*CF_DISTRIBUTION_ID"

user_setup:
  - service: aws
    why: "CDK must be bootstrapped before first deploy; stack must be deployed to generate outputs for GitHub secrets"
    dashboard_config:
      - task: "Run CDK bootstrap once from your machine with admin credentials"
        location: "Terminal (in infra/ directory): AWS_PROFILE=your-profile npx cdk bootstrap aws://ACCOUNT_ID/us-east-1"
      - task: "Run CDK deploy to provision infrastructure and get output values"
        location: "Terminal (in infra/ directory): AWS_PROFILE=your-profile npx cdk deploy"
  - service: github
    why: "Three GitHub Actions secrets must be set from CDK output values before the deploy job can run"
    env_vars:
      - name: AWS_DEPLOYER_ROLE_ARN
        source: "CDK output: BeeAtlasStack.DeployerRoleArn (shown after cdk deploy)"
      - name: S3_BUCKET_NAME
        source: "CDK output: BeeAtlasStack.BucketName (shown after cdk deploy)"
      - name: CF_DISTRIBUTION_ID
        source: "CDK output: BeeAtlasStack.DistributionId (shown after cdk deploy)"
    dashboard_config:
      - task: "Set three repository secrets"
        location: "GitHub → rainhead/beeatlas → Settings → Secrets and variables → Actions → New repository secret"
---

<objective>
Write the GitHub Actions workflow that builds the Vite frontend on every push and deploys to S3 + CloudFront on push to `main` using the OIDC deployer role provisioned in Plan 01. Then checkpoint to bootstrap CDK, deploy the stack, set GitHub secrets, and verify the live site.

Purpose: Closes the loop on the infrastructure phase — code is not done until it deploys automatically without stored credentials.
Output: `.github/workflows/deploy.yml` and a verified live CloudFront URL.
</objective>

<execution_context>
@/Users/rainhead/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rainhead/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-infrastructure/02-RESEARCH.md
@.planning/phases/02-infrastructure/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write GitHub Actions deploy workflow</name>
  <files>
    .github/workflows/deploy.yml
  </files>
  <action>
Create `.github/workflows/deploy.yml`. Two-job structure: `build` runs on all pushes, `deploy` runs only on push to `main`.

**Critical constraints:**
- `permissions: id-token: write` MUST be on the `deploy` JOB (not at the workflow level) — if only at workflow level with multiple jobs, the deploy job will fail with "Credentials could not be loaded"
- The `build` job does NOT need `id-token: write`
- Use `npm run build --workspace=frontend` (not `npm run build`) — the root `package.json` has no `build` script, only the frontend workspace does
- Use `aws-actions/configure-aws-credentials@v4` — no stored `aws-access-key-id` or `aws-secret-access-key`
- S3 sync: `aws s3 sync frontend/dist/ s3://${{ secrets.S3_BUCKET_NAME }} --delete`
- CloudFront invalidation uses wildcard `"/*"` (one free invalidation unit, not per-file)
- `deploy` job rebuilds the frontend itself (does not consume an artifact from `build`) — this avoids artifact upload/download complexity and keeps the deploy job self-contained

```yaml
name: Build and Deploy

on:
  push:
    branches: ['**']

jobs:
  build:
    name: Build frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build --workspace=frontend

  deploy:
    name: Deploy to S3 + CloudFront
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # Required for OIDC JWT request — must be on THIS job
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build --workspace=frontend

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOYER_ROLE_ARN }}
          aws-region: us-east-1

      - name: Sync to S3
        run: aws s3 sync frontend/dist/ s3://${{ secrets.S3_BUCKET_NAME }} --delete

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CF_DISTRIBUTION_ID }} \
            --paths "/*"
```
  </action>
  <verify>
Check the file exists and validate its structure:
```bash
cat .github/workflows/deploy.yml | grep -c "role-to-assume\|id-token: write\|S3_BUCKET_NAME\|CF_DISTRIBUTION_ID\|AWS_DEPLOYER_ROLE_ARN"
```
Should print 5 (one match per unique secret/permission reference).

Confirm no stored credentials:
```bash
grep -i "aws-access-key-id\|aws-secret-access-key" .github/workflows/deploy.yml
```
Must print nothing (grep exits 1 = no match = correct).

Confirm workspace build command (not bare `npm run build`):
```bash
grep "workspace=frontend\|--workspace" .github/workflows/deploy.yml
```
Must print at least two lines (build appears twice: once in build job, once in deploy job).
  </verify>
  <done>
`.github/workflows/deploy.yml` exists. File contains `role-to-assume`, `id-token: write` on the deploy job, correct workspace build command, S3 sync with `--delete`, and CloudFront invalidation with `/*`. No stored AWS credentials present.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Bootstrap CDK, deploy stack, set secrets, verify live site</name>
  <action>
Human action required. Pause and follow the verification steps below. Three things cannot be automated: CDK bootstrap (requires admin credentials from your machine), `cdk deploy` (provisions real AWS resources), and setting GitHub repository secrets (requires browser auth).

What was built automatically:
- Plan 01: CDK project in `infra/` with S3 bucket, CloudFront distribution (OAC), GitHub OIDC provider, deployer role, and CfnOutputs
- Task 1: GitHub Actions workflow `.github/workflows/deploy.yml`
  </action>
  <verify>
**Step 1 — Bootstrap CDK (one-time per account/region):**
```bash
cd infra
AWS_PROFILE=your-profile npx cdk bootstrap aws://YOUR_ACCOUNT_ID/us-east-1
```
Expected: "Environment aws://ACCOUNT/us-east-1 bootstrapped." If already bootstrapped, proceed.

**Step 2 — Deploy the stack:**
```bash
cd infra
AWS_PROFILE=your-profile npx cdk deploy
```
Expected: CloudFormation deploys ~10 resources. Outputs printed at end:
```
Outputs:
BeeAtlasStack.BucketName = beeatlastack-sitebucket-XXXX
BeeAtlasStack.DistributionId = EXXXXXXXXXXXX
BeeAtlasStack.DistributionDomain = dXXXXXXXXXXXXX.cloudfront.net
BeeAtlasStack.DeployerRoleArn = arn:aws:iam::ACCOUNT:role/beeatlas-github-deployer
```

**If deploy fails with "GitHubOidcProvider already exists":** Edit `infra/lib/beeatlas-stack.ts` — replace the `new iam.OpenIdConnectProvider(...)` block with:
```typescript
const githubProvider = iam.OpenIdConnectProvider.fromOpenIdConnectProviderArn(
  this, 'GitHubOidcProvider',
  `arn:aws:iam::${this.account}:oidc-provider/token.actions.githubusercontent.com`
);
```
Then re-run `npx cdk deploy`.

**Step 3 — Set GitHub repository secrets:**
Go to: https://github.com/rainhead/beeatlas/settings/secrets/actions
Set these three secrets (values from Step 2 outputs):
- `AWS_DEPLOYER_ROLE_ARN` = value of `BeeAtlasStack.DeployerRoleArn`
- `S3_BUCKET_NAME` = value of `BeeAtlasStack.BucketName`
- `CF_DISTRIBUTION_ID` = value of `BeeAtlasStack.DistributionId`

**Step 4 — Push to main and verify:**
Push the current branch to `main` (or merge a PR). Watch: https://github.com/rainhead/beeatlas/actions
Expected: `build` job passes on all pushes. `deploy` job runs on push to `main`, completes successfully.

**Step 5 — Verify the live site:**
Visit: `https://dXXXXXXXXXXXXX.cloudfront.net` (DistributionDomain from Step 2)
Expected: Bee atlas frontend loads. If XML error ("NoSuchKey"), wait 30 seconds and retry.
  </verify>
  <done>
CDK stack `BeeAtlasStack` deployed in us-east-1. Three GitHub secrets set. GitHub Actions `deploy` job completed successfully on push to `main`. CloudFront URL returns the frontend (HTTP 200).
  </done>
</task>

</tasks>

<verification>
After checkpoint approval:
1. GitHub Actions workflow ran successfully on push to `main` (green check in Actions tab)
2. `aws-actions/configure-aws-credentials@v4` step passed (OIDC token exchanged for temporary credentials)
3. `aws s3 sync` step passed (files in `frontend/dist/` uploaded to S3)
4. `aws cloudfront create-invalidation` step passed (invalidation created)
5. CloudFront URL returns the frontend (HTTP 200)
6. No `AWS_ACCESS_KEY_ID` or `AWS_SECRET_ACCESS_KEY` secrets exist in the repository
</verification>

<success_criteria>
- `.github/workflows/deploy.yml` exists with two jobs: `build` (all pushes) and `deploy` (main only)
- `deploy` job has `permissions: id-token: write` at the job level
- No stored AWS credentials in the workflow or repository secrets
- CDK stack deployed successfully — CloudFormation stack `BeeAtlasStack` exists in us-east-1
- Three GitHub secrets set: `AWS_DEPLOYER_ROLE_ARN`, `S3_BUCKET_NAME`, `CF_DISTRIBUTION_ID`
- CloudFront distribution accessible at a public `*.cloudfront.net` URL and serves the frontend
- INFRA-03 satisfied: workflow builds frontend on all pushes and deploys on push to `main`
</success_criteria>

<output>
After completion, create `.planning/phases/02-infrastructure/02-02-SUMMARY.md`
</output>
